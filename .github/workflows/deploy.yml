name: Automated Deployment

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push backend image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: proyecto-semilla-backend
        IMAGE_TAG: ${{ github.sha }}
        ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
      run: |
        # Build backend image with production optimizations
        docker build -f docker/backend/Dockerfile \
          --target runtime \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          --cache-from $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          ./backend

        # Push images
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    - name: Build and push frontend image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: proyecto-semilla-frontend
        IMAGE_TAG: ${{ github.sha }}
        ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
      run: |
        # Build frontend image with production optimizations
        docker build -f docker/frontend/Dockerfile \
          --target runner \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          --build-arg NEXT_PUBLIC_API_URL=https://api.${ENVIRONMENT}.proyecto-semilla.dev \
          --build-arg NEXT_PUBLIC_ENVIRONMENT=${ENVIRONMENT} \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          --cache-from $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          .

        # Push images
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    - name: Deploy to ECS
      env:
        ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
        CLUSTER_NAME: proyecto-semilla-${ENVIRONMENT}
        SERVICE_BACKEND: proyecto-semilla-backend
        SERVICE_FRONTEND: proyecto-semilla-frontend
      run: |
        # Update backend service
        aws ecs update-service \
          --cluster $CLUSTER_NAME \
          --service $SERVICE_BACKEND \
          --force-new-deployment \
          --deployment-configuration maximumPercent=200,minimumHealthyPercent=100

        # Update frontend service
        aws ecs update-service \
          --cluster $CLUSTER_NAME \
          --service $SERVICE_FRONTEND \
          --force-new-deployment \
          --deployment-configuration maximumPercent=200,minimumHealthyPercent=100

    - name: Wait for deployment
      env:
        ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
        CLUSTER_NAME: proyecto-semilla-${ENVIRONMENT}
        SERVICE_BACKEND: proyecto-semilla-backend
        SERVICE_FRONTEND: proyecto-semilla-frontend
      run: |
        # Wait for backend deployment
        aws ecs wait services-stable \
          --cluster $CLUSTER_NAME \
          --services $SERVICE_BACKEND

        # Wait for frontend deployment
        aws ecs wait services-stable \
          --cluster $CLUSTER_NAME \
          --services $SERVICE_FRONTEND

    - name: Health check
      env:
        ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
      run: |
        # Wait for services to be ready
        sleep 60

        # Check backend health
        BACKEND_URL="https://api.${ENVIRONMENT}.proyecto-semilla.dev/health"
        if curl -f -s --max-time 30 "$BACKEND_URL"; then
          echo "✅ Backend health check passed"
        else
          echo "❌ Backend health check failed"
          exit 1
        fi

        # Check frontend health
        FRONTEND_URL="https://app.${ENVIRONMENT}.proyecto-semilla.dev"
        if curl -f -s --max-time 30 "$FRONTEND_URL"; then
          echo "✅ Frontend health check passed"
        else
          echo "❌ Frontend health check failed"
          exit 1
        fi

    - name: Run smoke tests
      env:
        ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
      run: |
        # Run basic smoke tests
        npm install -g artillery

        # Run smoke test suite
        artillery run tests/performance/smoke-test.yml \
          --target "https://api.${ENVIRONMENT}.proyecto-semilla.dev" \
          --output smoke-test-results.json

    - name: Notify success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: "Deployment to ${{ github.event.inputs.environment || 'staging' }} completed successfully"
        fields: repo,message,commit,author,action,eventName,ref,workflow
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback:
    if: failure() && (github.event.inputs.environment == 'production' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    environment: production
    needs: [deploy]
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Rollback deployment
      env:
        ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
        CLUSTER_NAME: proyecto-semilla-${ENVIRONMENT}
        SERVICE_BACKEND: proyecto-semilla-backend
        SERVICE_FRONTEND: proyecto-semilla-frontend
      run: |
        # Get previous task definition
        PREVIOUS_BACKEND_TASK=$(aws ecs describe-services \
          --cluster $CLUSTER_NAME \
          --services $SERVICE_BACKEND \
          --query 'services[0].taskDefinition' \
          --output text)

        PREVIOUS_FRONTEND_TASK=$(aws ecs describe-services \
          --cluster $CLUSTER_NAME \
          --services $SERVICE_FRONTEND \
          --query 'services[0].taskDefinition' \
          --output text)

        # Rollback backend
        aws ecs update-service \
          --cluster $CLUSTER_NAME \
          --service $SERVICE_BACKEND \
          --task-definition $PREVIOUS_BACKEND_TASK \
          --force-new-deployment

        # Rollback frontend
        aws ecs update-service \
          --cluster $CLUSTER_NAME \
          --service $SERVICE_FRONTEND \
          --task-definition $PREVIOUS_FRONTEND_TASK \
          --force-new-deployment

    - name: Notify rollback
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: "Deployment failed, rollback initiated for ${{ github.event.inputs.environment || 'production' }}"
        fields: repo,message,commit,author,action,eventName,ref,workflow
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify:
    if: always()
    runs-on: ubuntu-latest
    needs: [deploy, rollback]
    steps:
    - name: Notify deployment status
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}